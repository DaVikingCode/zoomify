/*** MIT License** Copyright (c) 2020 akaadream @ Da Viking Code**/class Point{constructor(t,i){this.x=t,this.y=i}inArea(t){return t.x>=this.x-15&&t.x<=this.x+15&&t.y>=this.y-15&&t.y<=this.y+15}}class Polygon{constructor(t,i){this.color=i,this.points=t}}customElements.define("zoomify-img",class extends HTMLElement{constructor(){super(),this.color="#ff3333",this.markers=[],this.polygons=[],this.currentPosition=null,this.isDrawing=!1,this.canDraw=!1}init(t,i){if(this.startWidth=t,this.startHeight=i,t>i){let h=t/i;this.width=this.defaultWidth=this.clientWidth,this.height=this.defaultHeight=this.width/h}else{let h=i/t;this.height=this.defaultHeight=this.clientHeight,this.width=this.defaultWidth=this.height/h}this.containerWidth=this.clientWidth,this.containerHeight=this.clientHeight,this.containerX=this.offsetLeft,this.containerY=this.offsetTop,this.x=this.defaultX=this.height>this.width?this.clientWidth/2-this.width/2:0,this.y=this.defaultY=this.width>this.height?this.clientHeight/2-this.height/2:0,this.zoomSpeed=.1,this.dragging=!1,this.wasDragging=!1,this.hasMoved=!1,this.startDragX=0,this.startDragY=0,this.dragX=0,this.dragY=0,this.scaling=!1,this.touchDistance=0,this.touchCenterX=0,this.markers=[],this.polygons=[],this.touchCenterY=0,this.rect=this.getBoundingClientRect(),this.addEventListener("wheel",this.zoom),this.addEventListener("touchstart",this.touchStart),this.addEventListener("touchmove",this.touchMove),this.addEventListener("touchend",this.touchEnd),this.addEventListener("click",this.photoClicked),this.addEventListener("mousedown",this.startDrag),this.addEventListener("mousemove",this.drag),this.addEventListener("mouseup",this.endDrag),this.addEventListener("mouseleave",()=>{this.dragging=!1,this.dragX=0,this.dragY=0}),window.addEventListener("keyup",t=>{"Escape"===t.key&&this.cancelCurrent(!1)}),this.updateStyle(),this.render()}export(){if(0===this.polygons.length)return;let t="SRID=4326;POLYGON((",i=this.polygons[this.polygons.length-1];for(let h=0;h<i.points.length;h++){t+=i.points[h].x/this.startWidth+" "+i.points[h].y/this.startHeight+", "}return t+=i.points[0].x/this.startWidth+" "+i.points[0].y/this.startHeight,t+="))"}clickingOnExistingPoint(t){for(let i=0;i<this.markers.length;i++)if(this.markers[i].inArea(this.getZoomedPoint(t)))return!0;return!1}addPolygon(t,i){let h=[];for(let i=0;i<t.length;i++){let s=t[i][0]*this.startWidth,e=t[i][1]*this.startHeight;h.push(new Point(s,e))}let s=new Polygon(h,i);this.polygons.push(s),this.render()}touchStart(t){2===t.touches.length?(this.scaling=!0,this.pinchStart(t)):1===t.touches.length?(this.touchCenterX=t.touches[0].pageX,this.touchCenterY=t.touches[0].pageY,this.startDrag(t)):t.preventDefault()}touchMove(t){this.scaling?this.pinchMove(t):this.dragging?(this.touchCenterX=t.touches[0].pageX,this.touchCenterY=t.touches[0].pageY,this.drag(t)):t.preventDefault()}touchEnd(t){this.scaling?(this.pinchEnd(t),this.scaling=!1):this.dragging?(this.photoClicked(t),this.endDrag(t)):t.preventDefault()}pinchStart(t){this.touchCenterX=Math.abs(t.touches[0].pageX),this.touchCenterY=Math.abs(t.touches[0].pageY),this.touchDistance=Math.hypot(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY)}pinchMove(t){let i=Math.hypot(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY);i>this.touchDistance?this.zoom(t,-1):i<this.touchDistance&&this.zoom(t,1),this.touchDistance=i}pinchEnd(t){this.touchDistance=0,this.touchCenterX=0,this.touchCenterY=0}reset(){this.width=this.defaultWidth,this.height=this.defaultHeight,this.x=this.y=0,this.updateStyle()}cancelCurrent(t=!0){this.markers=[],t&&this.polygons.length>0&&this.polygons.pop(),this.render(),this.currentPosition=null,this.isDrawing=!1,this.canDraw=!1}photoClicked(t){if(!this.hasMoved&&this.canDraw)if(this.isDrawing||(this.isDrawing=!0),this.clickingOnExistingPoint(t)){this.isDrawing=!1,this.polygons.push(new Polygon(this.markers,this.color)),this.markers=[],this.currentPosition=null,this.canDraw=!1;const t=document.createEvent("Event");t.initEvent("drawn",!0,!0),this.dispatchEvent(t)}else{let i=this.getZoomedPoint(t);this.markers.push(i)}this.wasDragging=!1,this.hasMoved=!1,this.render(),t.preventDefault()}startDrag(t){this.dragging||(0!==this.touchCenterX||0!==this.touchCenterY?(this.dragX=this.startDragX=this.touchCenterX,this.dragY=this.startDragY=this.touchCenterY):(this.dragX=this.startDragX=t.clientX,this.dragY=this.startDragY=t.clientY),this.dragging=!0),t.preventDefault()}getZoomedPoint(t){let i=document.getElementById("canvas"),h=0,s=0;0!==this.touchCenterX&&0!==this.touchCenterY?(h=this.touchCenterX-this.rect.x-this.x,s=this.touchCenterY-this.rect.y-this.y):(h=t.pageX-this.rect.x-this.x,s=t.pageY-this.rect.y-this.y);let e=this.height/this.defaultHeight,n=this.startHeight/i.height;return this.startWidth>this.startHeight&&(n=this.startWidth/i.width),new Point(h/e*n,s/e*n)}drag(t){this.dragging&&(0!==this.touchCenterX||0!==this.touchCenterY?(this.x+=this.touchCenterX-this.dragX,this.y+=this.touchCenterY-this.dragY,(Math.abs(this.touchCenterX-this.startDragX)>=20||Math.abs(this.touchCenterY-this.startDragY)>=20)&&(this.hasMoved=!0),this.dragX=this.touchCenterX,this.dragY=this.touchCenterY):(this.x+=t.pageX-this.dragX,this.y+=t.pageY-this.dragY,(Math.abs(t.pageX-this.startDragX)>=20||Math.abs(t.pageY-this.startDragY)>=20)&&(this.hasMoved=!0),this.dragX=t.pageX,this.dragY=t.pageY),this.wasDragging=!0,this.updateStyle(),this.render()),this.isDrawing&&this.canDraw&&(this.markers[0].inArea(this.getZoomedPoint(t))?this.currentPosition=this.markers[0]:this.currentPosition=this.getZoomedPoint(t),this.render()),t.preventDefault()}endDrag(t){this.dragging=!1,this.touchCenterX=0,this.touchCenterY=0,this.startDragX=0,this.startDragY=0,t.preventDefault()}render(){let t=this.getCanvas(),i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.lineWidth=2,i.strokeStyle=this.color,i.fillStyle=this.color,this.renderArray(i,this.markers,!0,!0),this.polygonsRender()}renderArray(t,i,h=!0,s=!1){t.beginPath(),s&&t.setLineDash([15,5]);let e=document.getElementById("canvas"),n=this.width/this.startWidth;for(let s=0;s<i.length;s++){let r=i[s].x*n+this.x-e.offsetLeft,a=i[s].y*n+this.y-e.offsetTop;h&&(0===s&&(t.fillStyle="#ffffff"),t.fillRect(r-5,a-5,10,10),0===s&&(t.fillStyle=this.color)),0===s?t.moveTo(r,a):t.lineTo(r,a)}s&&this.isDrawing&&null!==this.currentPosition&&t.lineTo(this.currentPosition.x*n+this.x-e.offsetLeft,this.currentPosition.y*n+this.y-e.offsetTop),s&&this.isDrawing||!(i.length>0)||(t.lineTo(i[0].x*n+this.x-e.offsetLeft,i[0].y*n+this.y-e.offsetTop),t.closePath()),t.stroke(),s&&t.setLineDash([])}polygonsRender(){let t=this.getCanvas().getContext("2d");t.lineWidth=2;for(let i=0;i<this.polygons.length;i++)t.strokeStyle=this.polygons[i].color,t.fillStyle=this.polygons[i].color,this.renderArray(t,this.polygons[i].points,!1,!1)}dispose(){this.markers=[],this.polygons=[],this.canDraw=!1,this.childElementCount>0&&this.firstChild.remove()}getCanvas(){let t=document.getElementById("canvas");return t||((t=document.createElement("canvas")).setAttribute("width",this.defaultWidth),t.setAttribute("height",this.defaultHeight),t.setAttribute("id","canvas"),t.style.marginTop=this.defaultY+"px",t.style.marginLeft=this.defaultX+"px",this.appendChild(t)),t}zoom(t,i=0){let h=i<0||t.deltaY<0,s=i>0||t.deltaY>0,e=this.getBoundingClientRect(),n=t.pageX-e.left-window.pageXOffset,r=t.pageY-e.top-window.pageYOffset;0!==i&&(n=this.touchCenterX-e.left-window.pageXOffset,r=this.touchCenterY-e.top-window.pageYOffset);let a=n-this.x,o=r-this.y,g=a/this.width,d=o/this.height;h&&this.width<4*this.containerWidth?(this.width+=this.width*this.zoomSpeed,this.height+=this.height*this.zoomSpeed):s&&this.width>this.defaultWidth&&(this.width-=this.width*this.zoomSpeed,this.height-=this.height*this.zoomSpeed),this.width<this.defaultWidth&&(this.width=this.defaultWidth),this.height<this.defaultHeight&&(this.height=this.defaultHeight),this.x=n-this.width*g,this.y=r-this.height*d,this.width<=this.defaultWidth||this.height<=this.defaultHeight?this.reset():this.updateStyle(),this.updateCanvas(),this.render(),t.preventDefault()}updateCanvas(){let t=document.getElementById("canvas");if(this.defaultWidth>this.defaultHeight){let i=this.height;i>this.rect.height&&(i=this.rect.height),t.setAttribute("height",i);let h=(this.defaultY+this.y)/2;(h<0||this.height>this.rect.height)&&(h=0),t.style.marginTop=h+"px"}else{let i=this.width;i>this.rect.width&&(i=this.rect.width),t.setAttribute("width",i);let h=(this.defaultX+this.x)/2;(h<0||this.width>this.rect.width)&&(h=0),t.style.marginLeft=h+"px"}}updateStyle(){this.x>0?this.x=0:this.x<this.defaultWidth-this.width&&(this.x=this.defaultWidth-this.width),this.y>0?this.y=0:this.y<this.defaultHeight-this.height&&(this.y=this.defaultHeight-this.height),this.width>this.height?this.height<this.clientHeight&&(this.y=this.defaultY=this.width>this.height?this.clientHeight/2-this.height/2:0):this.width<this.clientWidth&&(this.x=this.defaultX=this.height>this.width?this.clientWidth/2-this.width/2:0),this.style.backgroundSize=this.width+"px "+this.height+"px",this.style.backgroundPosition=this.x+"px "+this.y+"px"}});
